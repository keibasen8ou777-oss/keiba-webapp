{% extends "layout.html" %}

{% block title %}{{ horse_data.name or '詳細' }}{% endblock %}

{% block content %}
<header class="mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="javascript:history.back()" class="btn btn-secondary btn-sm">&laquo; 前に戻る</a>
    <h1 class="display-5 mb-0">{{ horse_data.name or '詳細データ' }}</h1>
    <a href="{{ url_for('home') }}" class="btn btn-primary btn-sm">HOME</a>
  </div>
  <p class="text-muted text-center">ID: {{ horse_id }}</p>
</header>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">血統情報</h5>
  </div>
  <div class="card-body">
    <div class="row">
      {# --- 父系 --- #}
      <div class="col-lg-6 mb-4 mb-lg-0">
        <h6 class="mb-3">父系</h6>
        <p>
          <strong>父:</strong>
          {% if horse_data.sire_id and horse_data.sire_id != 'N/A' %}
            <a href="{{ url_for('artifact_detail', artifact_id=horse_data.sire_id) }}">{{ horse_data.sire or 'N/A' }}</a>
          {% else %}
            {{ horse_data.sire or 'N/A' }}
          {% endif %}
        </p>
        {% if sire_tendency and sire_tendency.by_distance %}
          <div class="ms-3">
            <small class="text-muted">{{ horse_data.sire }} の産駒成績 (距離別)</small>
            <table class="table table-sm table-bordered small mt-1">
              <thead class="table-light">
                <tr>
                  <th>距離</th><th>1着</th><th>2着</th><th>3着</th><th>着外</th><th>勝率</th><th>連対率</th>
                </tr>
              </thead>
              <tbody>
                {% for row in sire_tendency.by_distance %}
                  <tr>
                    <td>{{ row.get('距離_距離', '-') }}</td>
                    <td>{{ row.get('着別度数_1着', '-') }}</td>
                    <td>{{ row.get('着別度数_2着', '-') }}</td>
                    <td>{{ row.get('着別度数_3着', '-') }}</td>
                    <td>{{ row.get('着別度数_着外', '-') }}</td>
                    <td>{{ row.get('勝率_勝率', '-') }}</td>
                    <td>{{ row.get('連対率_連対率', '-') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
        <p class="mt-3">
          <strong class="ms-3">父父:</strong> {{ horse_data.paternal_grandsire or 'N/A' }}<br>
          <strong class="ms-3">父母:</strong> {{ horse_data.paternal_granddam or 'N/A' }}
        </p>
      </div>

      {# --- 母系 --- #}
      <div class="col-lg-6">
        <h6 class="mb-3">母系</h6>
        <p>
          <strong>母:</strong>
          {% if horse_data.dam_id and horse_data.dam_id != 'N/A' %}
            <a href="{{ url_for('artifact_detail', artifact_id=horse_data.dam_id) }}">{{ horse_data.dam or 'N/A' }}</a>
          {% else %}
            {{ horse_data.dam or 'N/A' }}
          {% endif %}
        </p>
        {% if dam_tendency and dam_tendency.by_distance %}
          <div class="ms-3">
            <small class="text-muted">{{ horse_data.dam }} の産駒成績 (距離別)</small>
            <table class="table table-sm table-bordered small mt-1">
              <thead class="table-light">
                <tr>
                  <th>距離</th><th>1着</th><th>2着</th><th>3着</th><th>着外</th><th>勝率</th><th>連対率</th>
                </tr>
              </thead>
              <tbody>
                {% for row in dam_tendency.by_distance %}
                  <tr>
                    <td>{{ row.get('距離_距離', '-') }}</td>
                    <td>{{ row.get('着別度数_1着', '-') }}</td>
                    <td>{{ row.get('着別度数_2着', '-') }}</td>
                    <td>{{ row.get('着別度数_3着', '-') }}</td>
                    <td>{{ row.get('着別度数_着外', '-') }}</td>
                    <td>{{ row.get('勝率_勝率', '-') }}</td>
                    <td>{{ row.get('連対率_連対率', '-') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
        <p class="mt-3">
          <strong class="ms-3">母父:</strong> {{ horse_data.maternal_grandsire or 'N/A' }}<br>
          <strong class="ms-3">母母:</strong> {{ horse_data.maternal_granddam or 'N/A' }}
        </p>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">個人メモ</div>
  <div class="card-body">
    <textarea id="memo-textarea" class="form-control" rows="5" placeholder="ここにメモを入力してください...">{{ horse_data.memo or '' }}</textarea>
    <button id="save-memo-btn" class="btn btn-success mt-2">メモを保存</button>
    <div id="memo-status" class="mt-2"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const saveBtn = document.getElementById('save-memo-btn');
  const memoTextarea = document.getElementById('memo-textarea');
  const memoStatus = document.getElementById('memo-status');
  const horseId = '{{ horse_id }}';

  saveBtn.addEventListener('click', async () => {
    const memoText = memoTextarea.value;
    memoStatus.textContent = '保存中...';
    memoStatus.className = 'text-muted';

    try {
      const response = await fetch('/api/save_memo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          horse_id: horseId,
          memo_text: memoText,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || '保存に失敗しました。');
      }

      const result = await response.json();
      memoStatus.textContent = result.message || '保存しました！';
      memoStatus.className = 'text-success';

    } catch (error) {
      memoStatus.textContent = error.message || '保存中にエラーが発生しました。';
      memoStatus.className = 'text-danger';
    }
  });
});
</script>
{% endblock %}
